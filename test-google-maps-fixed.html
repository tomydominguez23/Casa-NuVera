<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Google Maps Fix - Casa Nuvera</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background-color: #f8f9fa;
        }
        
        .test-container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .test-title {
            color: #2c3e50;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            color: #2c3e50;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .form-control {
            width: 100%;
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .map-preview-container {
            margin-top: 1.5rem;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .map-preview-header {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .map-preview-header h4 {
            margin: 0;
            font-size: 1rem;
            color: #333;
            font-weight: 600;
        }
        
        .map-preview {
            height: 400px;
            position: relative;
            background: #f8f9fa;
        }
        
        .map-preview iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .map-preview-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            text-align: center;
        }
        
        .map-preview-placeholder .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .test-results {
            background: #e8f4f8;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .test-urls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .test-url-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .test-url-item h5 {
            margin: 0 0 0.5rem 0;
            color: #2c3e50;
        }
        
        .test-url-item code {
            background: #e9ecef;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.8rem;
            word-break: break-all;
        }
        
        .btn-test {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 0.25rem;
            transition: background 0.3s;
        }
        
        .btn-test:hover {
            background: #2980b9;
        }
        
        .success {
            color: #27ae60;
            font-weight: 600;
        }
        
        .error {
            color: #e74c3c;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-title">üß™ Test de Google Maps Fix</h1>
        <p>Esta p√°gina prueba la correcci√≥n del error de Google Maps en Casa Nuvera.</p>
        
        <div class="form-group">
            <label for="testUrl">URL de Google Maps para probar:</label>
            <input type="url" id="testUrl" class="form-control" 
                   placeholder="Pega aqu√≠ una URL de Google Maps">
        </div>
        
        <div class="map-preview-container" id="mapPreviewContainer" style="display: none;">
            <div class="map-preview-header">
                <h4>üìç Vista Previa del Mapa</h4>
            </div>
            <div class="map-preview" id="mapPreview">
                <!-- El iframe del mapa se insertar√° aqu√≠ -->
            </div>
        </div>
        
        <div class="test-results" id="testResults" style="display: none;">
            <strong>üìä Resultados del Test:</strong>
            <div id="resultsContent"></div>
        </div>
        
        <div class="test-urls">
            <h3>üîó URLs de Prueba</h3>
            
            <div class="test-url-item">
                <h5>maps.app.goo.gl (Formato actual)</h5>
                <code>https://maps.app.goo.gl/5d7wLipgBWWBeos99?g_st=iwb</code>
                <br><br>
                <button class="btn-test" onclick="testUrl('https://maps.app.goo.gl/5d7wLipgBWWBeos99?g_st=iwb')">
                    Probar este URL
                </button>
            </div>
            
            <div class="test-url-item">
                <h5>goo.gl/maps (Formato anterior)</h5>
                <code>https://goo.gl/maps/gwUah7NsXmrLhqUL9</code>
                <br><br>
                <button class="btn-test" onclick="testUrl('https://goo.gl/maps/gwUah7NsXmrLhqUL9')">
                    Probar este URL
                </button>
            </div>
            
            <div class="test-url-item">
                <h5>Google Maps con coordenadas</h5>
                <code>https://www.google.com/maps/@-33.4489,-70.6693,15z</code>
                <br><br>
                <button class="btn-test" onclick="testUrl('https://www.google.com/maps/@-33.4489,-70.6693,15z')">
                    Probar este URL
                </button>
            </div>
            
            <div class="test-url-item">
                <h5>URL embed (ya formateado)</h5>
                <code>https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3329.2!2d-70.6693!3d-33.4489!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zMzPCsDI2JzU2LjAiUyA3MMKwNDAnMDkuNSJX!5e0!3m2!1ses!2scl!4v1234567890123!5m2!1ses!2scl</code>
                <br><br>
                <button class="btn-test" onclick="testUrl('https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3329.2!2d-70.6693!3d-33.4489!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zMzPCsDI2JzU2LjAiUyA3MMKwNDAnMDkuNSJX!5e0!3m2!1ses!2scl!4v1234567890123!5m2!1ses!2scl')">
                    Probar este URL
                </button>
            </div>
        </div>
    </div>

    <script>
        // Funci√≥n corregida para convertir URLs de Google Maps
        function convertToEmbedUrl(url) {
            try {
                console.log('üîÑ Convirtiendo URL de mapa:', url);
                
                // SOLUCI√ìN CORREGIDA: URLs de maps.app.goo.gl funcionan directamente en iframes
                // NO necesitan conversi√≥n a /embed/
                
                // Si ya es una URL de embed, devolverla tal como est√°
                if (url.includes('embed')) {
                    console.log('‚úÖ URL ya es embed');
                    return url;
                }

                // CORRECCI√ìN PRINCIPAL: URLs de maps.app.goo.gl funcionan directamente
                if (url.includes('maps.app.goo.gl')) {
                    console.log('‚úÖ URL de maps.app.goo.gl - usando directamente (sin conversi√≥n)');
                    return url; // ¬°Estos URLs funcionan directamente en iframes!
                }

                // URLs de goo.gl/maps tambi√©n funcionan directamente
                if (url.includes('goo.gl/maps')) {
                    console.log('‚úÖ URL de goo.gl/maps - usando directamente');
                    return url; // ¬°Estos tambi√©n funcionan directamente!
                }

                // Para URLs completas de Google Maps con coordenadas
                if (url.includes('maps.google.com') || url.includes('google.com/maps')) {
                    console.log('‚úÖ URL de Google Maps detectada');
                    
                    // Extraer coordenadas si existen
                    const coordsMatch = url.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
                    if (coordsMatch) {
                        const [, lat, lng] = coordsMatch;
                        const embedUrl = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3329.2!2d${lng}!3d${lat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zM${lat}%2C${lng}!5e0!3m2!1ses!2scl!4v1234567890123!5m2!1ses!2scl`;
                        console.log('‚úÖ URL generada con coordenadas');
                        return embedUrl;
                    }
                    
                    // Si no tiene coordenadas, usar como b√∫squeda
                    const searchQuery = encodeURIComponent(url);
                    const embedUrl = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3329.2!2d-70.6693!3d-33.4489!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zMzPCsDI2JzU2LjAiUyA3MMKwNDAnMDkuNSJX!5e0!3m2!1ses!2scl!4v1234567890123!5m2!1ses!2scl&q=${searchQuery}`;
                    console.log('‚úÖ URL convertida para b√∫squeda');
                    return embedUrl;
                }
                
                console.log('‚ùå URL no reconocida como Google Maps');
                return null;
            } catch (error) {
                console.error('‚ùå Error convirtiendo URL de mapa:', error);
                return null;
            }
        }

        function updateMapPreview(url) {
            const container = document.getElementById('mapPreviewContainer');
            const preview = document.getElementById('mapPreview');
            const results = document.getElementById('testResults');
            const resultsContent = document.getElementById('resultsContent');
            
            if (!container || !preview) {
                console.log('‚ö†Ô∏è Elementos de preview de mapa no encontrados');
                return;
            }
            
            // Mostrar loading
            preview.innerHTML = `
                <div class="map-preview-placeholder">
                    <div class="icon">‚è≥</div>
                    <div>
                        <strong>Cargando mapa...</strong><br>
                        Procesando: ${url.length > 50 ? url.substring(0, 50) + '...' : url}
                    </div>
                </div>
            `;
            container.style.display = 'block';
            
            // Convertir URL de Google Maps a iframe embed
            const embedUrl = convertToEmbedUrl(url);
            
            if (embedUrl) {
                // Crear iframe con manejo de errores
                const iframe = document.createElement('iframe');
                iframe.src = embedUrl;
                iframe.allowFullscreen = true;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                
                let loadSuccess = false;
                let loadError = false;
                
                // Manejar errores de carga del iframe
                iframe.onerror = function() {
                    console.error('‚ùå Error cargando iframe del mapa');
                    loadError = true;
                    showTestResults(false, 'Error cargando el mapa. Verifica que la URL sea v√°lida.', url, embedUrl);
                };
                
                iframe.onload = function() {
                    console.log('‚úÖ Mapa cargado exitosamente');
                    loadSuccess = true;
                    showTestResults(true, 'Mapa cargado correctamente', url, embedUrl);
                };
                
                // Timeout para detectar si no carga
                setTimeout(() => {
                    if (!loadSuccess && !loadError) {
                        console.log('‚ö†Ô∏è Timeout cargando mapa');
                        showTestResults(false, 'Timeout cargando el mapa', url, embedUrl);
                    }
                }, 10000);
                
                // Limpiar placeholder y agregar iframe
                preview.innerHTML = '';
                preview.appendChild(iframe);
                
                console.log('üó∫Ô∏è Mapa actualizado:', embedUrl);
            } else {
                showMapError('URL de Google Maps no v√°lida. Usa una URL de maps.google.com, goo.gl/maps o maps.app.goo.gl');
                showTestResults(false, 'URL no v√°lida', url, null);
            }
        }

        function showMapError(message) {
            const container = document.getElementById('mapPreviewContainer');
            const preview = document.getElementById('mapPreview');
            
            if (!container || !preview) return;
            
            preview.innerHTML = `
                <div class="map-preview-placeholder">
                    <div class="icon">‚ö†Ô∏è</div>
                    <div>
                        <strong>${message}</strong><br>
                        Por favor, usa una URL de Google Maps v√°lida
                    </div>
                </div>
            `;
            container.style.display = 'block';
        }

        function showTestResults(success, message, originalUrl, embedUrl) {
            const results = document.getElementById('testResults');
            const resultsContent = document.getElementById('resultsContent');
            
            const statusClass = success ? 'success' : 'error';
            const statusIcon = success ? '‚úÖ' : '‚ùå';
            
            resultsContent.innerHTML = `
                <div class="${statusClass}">
                    ${statusIcon} <strong>${message}</strong>
                </div>
                <br>
                <strong>URL Original:</strong><br>
                <code style="word-break: break-all;">${originalUrl}</code>
                <br><br>
                <strong>URL Embed:</strong><br>
                <code style="word-break: break-all;">${embedUrl || 'No se pudo convertir'}</code>
                <br><br>
                <strong>Timestamp:</strong> ${new Date().toLocaleString()}
            `;
            
            results.style.display = 'block';
        }

        function testUrl(url) {
            document.getElementById('testUrl').value = url;
            updateMapPreview(url);
        }

        // Event listener para el campo de entrada
        document.getElementById('testUrl').addEventListener('input', function() {
            const url = this.value.trim();
            if (url) {
                updateMapPreview(url);
            } else {
                document.getElementById('mapPreviewContainer').style.display = 'none';
                document.getElementById('testResults').style.display = 'none';
            }
        });

        console.log('üß™ Test de Google Maps Fix inicializado');
    </script>
</body>
</html>