    <script>
        // Variables globales
        let allProperties = [];

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè† Iniciando p√°gina de arriendos...');
            
            // Esperar a que Supabase est√© listo
            if (window.supabase) {
                initializePage();
            } else {
                window.addEventListener('supabaseReady', initializePage);
                
                // Timeout de seguridad
                setTimeout(() => {
                    if (!window.supabase) {
                        showError('No se pudo conectar con Supabase');
                    }
                }, 5000);
            }
        });

        async function initializePage() {
            console.log('üöÄ Configurando p√°gina de arriendos...');
            await loadProperties();
        }

        async function loadProperties() {
            try {
                showLoading(true);
                
                console.log('üì• Cargando propiedades en arriendo desde tabla "properties"...');
                
                // Query simplificado SIN JOIN - solo cargar propiedades de arriendo
                const { data, error } = await window.supabase
                    .from('properties')
                    .select('*')
                    .eq('published', true)
                    .in('property_type', ['arriendo', 'arriendo-temporal'])
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('‚ùå Error al cargar propiedades:', error);
                    throw error;
                }

                allProperties = data || [];
                console.log(`‚úÖ ${allProperties.length} propiedades cargadas`);
                
                // Cargar im√°genes por separado para cada propiedad
                await loadPropertyImages();
                
                showLoading(false);
                renderProperties();
                
            } catch (error) {
                console.error('üí• Error al cargar propiedades:', error);
                showError(`Error al cargar propiedades: ${error.message}`);
                showLoading(false);
            }
        }

        async function loadPropertyImages() {
            console.log('üñºÔ∏è Cargando im√°genes de propiedades...');
            
            for (let property of allProperties) {
                try {
                    // Intentar cargar imagen principal por separado
                    const { data: images, error } = await window.supabase
                        .from('property_images')
                        .select('image_url, is_main')
                        .eq('property_id', property.id)
                        .order('is_main', { ascending: false });

                    if (!error && images && images.length > 0) {
                        property.images = images;
                        property.main_image = images.find(img => img.is_main)?.image_url || images[0].image_url;
                    }
                } catch (e) {
                    console.warn(`‚ö†Ô∏è No se pudo cargar imagen para propiedad ${property.id}:`, e);
                }
            }
            
            console.log('‚úÖ Im√°genes cargadas');
        }

        function renderProperties() {
            const grid = document.getElementById('propertiesGrid');
            const resultsCount = document.getElementById('resultsCount');

            if (allProperties.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 4rem 2rem;">
                        <h3>No hay propiedades en arriendo disponibles</h3>
                        <p>Intenta nuevamente m√°s tarde</p>
                        <button class="btn btn-primary" onclick="location.reload()">üîÑ Recargar</button>
                    </div>
                `;
                resultsCount.textContent = 'No se encontraron propiedades';
                return;
            }

            // Renderizar propiedades con efecto hover premium
            const propertiesHTML = allProperties.map(property => {
                const formattedPrice = formatPrice(property.price, property.currency);
                const features = [];
                
                if (property.bedrooms !== null && property.bedrooms !== undefined) {
                    features.push(`${property.bedrooms === 0 ? 'Studio' : property.bedrooms + ' dormitorios'}`);
                }
                if (property.bathrooms) features.push(`${property.bathrooms} ba√±os`);
                if (property.total_area) features.push(`${property.total_area}m¬≤`);
                if (property.parking_spaces > 0) features.push(`${property.parking_spaces} estacionamientos`);

                const contactInfo = property.contact_phone || property.contact_email || 'Contactar para m√°s informaci√≥n';
                const badgeText = property.property_type === 'arriendo-temporal' ? 'ARRIENDO TEMPORAL' : 'ARRIENDO';

                return `
                    <div class="property-card" data-id="${property.id}">
                        <div class="property-image ${property.main_image ? 'has-image' : 'no-image'}">
                            ${property.main_image ? 
                                `<img src="${property.main_image}" alt="${property.title}" onerror="this.style.display='none'; this.parentNode.classList.add('no-image');">` : 
                                `<div class="placeholder-image">
                                    <div class="placeholder-icon">üè†</div>
                                    <div class="placeholder-text">Sin imagen</div>
                                </div>`
                            }
                            <div class="property-badge ${property.featured ? 'featured' : ''}">
                                ${property.featured ? '‚≠ê ' : ''}${badgeText}
                            </div>
                            
                            <!-- Informaci√≥n adicional que aparece en hover -->
                            <div class="property-hover-info">
                                <h4>${property.title}</h4>
                                <div class="hover-price">${formattedPrice}</div>
                                <p>üìç ${property.address}, ${property.commune}</p>
                                <div class="hover-features">${features.join(' ‚Ä¢ ')}</div>
                                ${property.expenses ? 
                                    `<p>üí∞ Gastos comunes: $${new Intl.NumberFormat('es-CL').format(property.expenses)}</p>` : 
                                    ''
                                }
                                <div class="hover-contact">üìû ${contactInfo}</div>
                            </div>
                        </div>
                        
                        <div class="property-info">
                            <div class="property-price">${formattedPrice}</div>
                            <h3 class="property-title">${property.title}</h3>
                            <div class="property-location">
                                üìç ${property.commune}${property.neighborhood ? ', ' + property.neighborhood : ''}
                            </div>
                            <div class="property-features">
                                ${features.join(' ‚Ä¢ ')}
                            </div>
                            ${property.expenses ? 
                                `<div class="property-expenses">üí∞ Gastos comunes: $${property.expenses.toLocaleString()}</div>` : 
                                ''
                            }
                            <div class="property-contact">
                                <button class="contact-btn" onclick="contactProperty('${property.id}')">
                                    üí¨ Contactar por WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = propertiesHTML;
            resultsCount.textContent = `Mostrando ${allProperties.length} propiedades en arriendo`;

            // Mostrar la secci√≥n de propiedades
            document.getElementById('propertiesSection').style.display = 'block';
        }

        function formatPrice(price, currency) {
            const numPrice = parseFloat(price);
            
            switch(currency) {
                case 'CLP':
                    return `$${numPrice.toLocaleString('es-CL')}`;
                case 'UF':
                    return `UF ${numPrice.toLocaleString('es-CL')}`;
                case 'USD':
                    return `US$ ${numPrice.toLocaleString('en-US')}`;
                default:
                    return `${currency || '$'} ${numPrice.toLocaleString()}`;
            }
        }

        function showLoading(show) {
            const loadingContainer = document.getElementById('loadingContainer');
            const propertiesSection = document.getElementById('propertiesSection');
            const errorContainer = document.getElementById('errorContainer');
            
            if (show) {
                loadingContainer.style.display = 'flex';
                propertiesSection.style.display = 'none';
                errorContainer.style.display = 'none';
            } else {
                loadingContainer.style.display = 'none';
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            const loadingContainer = document.getElementById('loadingContainer');
            const propertiesSection = document.getElementById('propertiesSection');
            
            errorMessage.textContent = message;
            errorContainer.style.display = 'block';
            loadingContainer.style.display = 'none';
            propertiesSection.style.display = 'none';
        }

        // Funci√≥n global para contactar propiedades
        window.contactProperty = function(propertyId) {
            const property = allProperties.find(p => p.id === propertyId);
            
            if (!property) {
                alert('Propiedad no encontrada');
                return;
            }

            const features = [];
            if (property.bedrooms !== null && property.bedrooms !== undefined) {
                features.push(`${property.bedrooms === 0 ? 'Studio' : property.bedrooms + ' dormitorios'}`);
            }
            if (property.bathrooms) features.push(`${property.bathrooms} ba√±os`);
            if (property.total_area) features.push(`${property.total_area}m¬≤`);
            if (property.parking_spaces > 0) features.push(`${property.parking_spaces} estacionamientos`);

            const message = `Hola! Estoy interesado/a en arrendar la propiedad "${property.title}" ubicada en ${property.commune}.

üìç Direcci√≥n: ${property.address}
üí∞ Precio: ${formatPrice(property.price, property.currency)}${property.property_type === 'arriendo-temporal' ? ' (temporal)' : ''}
üè† ${features.join(', ')}
${property.expenses ? `üí∏ Gastos comunes: $${property.expenses.toLocaleString()}` : ''}

¬øPodr√≠as darme m√°s informaci√≥n?`;

            // Limpiar n√∫mero de tel√©fono
            const phoneNumber = property.contact_phone.replace(/[^0-9]/g, '');
            const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            
            console.log('üì± Abriendo WhatsApp para propiedad:', property.title);
            window.open(whatsappURL, '_blank');
        };
    </script>