// test-image-functionality.js - Script para probar la funcionalidad de im√°genes
console.log('üß™ Iniciando pruebas de funcionalidad de im√°genes...');

class ImageFunctionalityTester {
    constructor() {
        this.supabase = null;
        this.testResults = [];
    }

    async initialize() {
        try {
            // Esperar a que Supabase est√© disponible
            if (!window.supabase) {
                console.log('‚è≥ Esperando Supabase...');
                await this.waitForSupabase();
            }
            
            this.supabase = window.supabase;
            console.log('‚úÖ Supabase disponible para pruebas');
            
            // Ejecutar todas las pruebas
            await this.runAllTests();
            
            // Mostrar resultados
            this.showResults();
            
        } catch (error) {
            console.error('‚ùå Error en ImageFunctionalityTester:', error);
        }
    }

    async waitForSupabase() {
        return new Promise((resolve) => {
            const checkSupabase = () => {
                if (window.supabase) {
                    resolve();
                } else {
                    setTimeout(checkSupabase, 100);
                }
            };
            checkSupabase();
        });
    }

    async runAllTests() {
        console.log('üß™ Ejecutando pruebas de funcionalidad...');
        
        // Test 1: Verificar conexi√≥n a Supabase
        await this.testSupabaseConnection();
        
        // Test 2: Verificar estructura de tablas
        await this.testTableStructure();
        
        // Test 3: Verificar carga de propiedades
        await this.testLoadProperties();
        
        // Test 4: Verificar carga de im√°genes
        await this.testLoadImages();
        
        // Test 5: Verificar funciones de eliminaci√≥n
        await this.testDeletionFunctions();
        
        console.log('‚úÖ Todas las pruebas completadas');
    }

    async testSupabaseConnection() {
        try {
            console.log('üîç Probando conexi√≥n a Supabase...');
            
            const { data, error } = await this.supabase
                .from('properties')
                .select('count')
                .limit(1);
            
            if (error) {
                throw new Error(`Error de conexi√≥n: ${error.message}`);
            }
            
            this.testResults.push({
                test: 'Supabase Connection',
                status: 'PASS',
                message: 'Conexi√≥n exitosa'
            });
            
        } catch (error) {
            this.testResults.push({
                test: 'Supabase Connection',
                status: 'FAIL',
                message: error.message
            });
        }
    }

    async testTableStructure() {
        try {
            console.log('üîç Probando estructura de tablas...');
            
            // Probar tabla properties
            const { error: propError } = await this.supabase
                .from('properties')
                .select('id')
                .limit(1);
            
            if (propError) {
                throw new Error(`Error en tabla properties: ${propError.message}`);
            }
            
            // Probar tabla property_images
            const { error: imgError } = await this.supabase
                .from('property_images')
                .select('id')
                .limit(1);
            
            if (imgError) {
                throw new Error(`Error en tabla property_images: ${imgError.message}`);
            }
            
            this.testResults.push({
                test: 'Table Structure',
                status: 'PASS',
                message: 'Estructura de tablas correcta'
            });
            
        } catch (error) {
            this.testResults.push({
                test: 'Table Structure',
                status: 'FAIL',
                message: error.message
            });
        }
    }

    async testLoadProperties() {
        try {
            console.log('üîç Probando carga de propiedades...');
            
            const { data: properties, error } = await this.supabase
                .from('properties')
                .select(`
                    id,
                    title,
                    property_type,
                    category,
                    bedrooms,
                    bathrooms,
                    price,
                    currency,
                    commune,
                    published
                `)
                .eq('published', true)
                .limit(5);
            
            if (error) {
                throw new Error(`Error cargando propiedades: ${error.message}`);
            }
            
            this.testResults.push({
                test: 'Load Properties',
                status: 'PASS',
                message: `${properties.length} propiedades cargadas`
            });
            
        } catch (error) {
            this.testResults.push({
                test: 'Load Properties',
                status: 'FAIL',
                message: error.message
            });
        }
    }

    async testLoadImages() {
        try {
            console.log('üîç Probando carga de im√°genes...');
            
            // Obtener una propiedad con im√°genes
            const { data: properties, error: propError } = await this.supabase
                .from('properties')
                .select('id, title')
                .eq('published', true)
                .limit(1);
            
            if (propError || !properties || properties.length === 0) {
                throw new Error('No hay propiedades para probar');
            }
            
            const propertyId = properties[0].id;
            
            // Cargar im√°genes de la propiedad
            const { data: images, error: imgError } = await this.supabase
                .from('property_images')
                .select('id, image_url, is_main')
                .eq('property_id', propertyId);
            
            if (imgError) {
                throw new Error(`Error cargando im√°genes: ${imgError.message}`);
            }
            
            this.testResults.push({
                test: 'Load Images',
                status: 'PASS',
                message: `${images.length} im√°genes encontradas para propiedad ${propertyId}`
            });
            
        } catch (error) {
            this.testResults.push({
                test: 'Load Images',
                status: 'FAIL',
                message: error.message
            });
        }
    }

    async testDeletionFunctions() {
        try {
            console.log('üîç Probando funciones de eliminaci√≥n...');
            
            // Verificar que las funciones est√©n disponibles
            const functions = [
                'deletePropertyImageImproved',
                'getPropertyImages',
                'setMainImage',
                'moveImage'
            ];
            
            const missingFunctions = functions.filter(func => !window[func]);
            
            if (missingFunctions.length > 0) {
                throw new Error(`Funciones faltantes: ${missingFunctions.join(', ')}`);
            }
            
            this.testResults.push({
                test: 'Deletion Functions',
                status: 'PASS',
                message: 'Todas las funciones de eliminaci√≥n est√°n disponibles'
            });
            
        } catch (error) {
            this.testResults.push({
                test: 'Deletion Functions',
                status: 'FAIL',
                message: error.message
            });
        }
    }

    showResults() {
        console.log('üìä Resultados de las pruebas:');
        console.table(this.testResults);
        
        const passed = this.testResults.filter(r => r.status === 'PASS').length;
        const failed = this.testResults.filter(r => r.status === 'FAIL').length;
        
        console.log(`‚úÖ Pruebas exitosas: ${passed}`);
        console.log(`‚ùå Pruebas fallidas: ${failed}`);
        
        if (failed === 0) {
            console.log('üéâ ¬°Todas las pruebas pasaron! El sistema de im√°genes est√° funcionando correctamente.');
        } else {
            console.log('‚ö†Ô∏è Algunas pruebas fallaron. Revisa los errores arriba.');
        }
        
        return {
            passed,
            failed,
            total: this.testResults.length,
            results: this.testResults
        };
    }

    // Funci√≥n para probar la eliminaci√≥n de una imagen espec√≠fica
    async testImageDeletion(propertyId, imageId) {
        try {
            console.log(`üß™ Probando eliminaci√≥n de imagen ${imageId} de propiedad ${propertyId}...`);
            
            if (!window.deletePropertyImageImproved) {
                throw new Error('Funci√≥n de eliminaci√≥n mejorada no est√° disponible');
            }
            
            const result = await window.deletePropertyImageImproved(propertyId, null, imageId);
            
            if (result.success) {
                console.log('‚úÖ Eliminaci√≥n de imagen exitosa');
                return { success: true };
            } else {
                console.error('‚ùå Error en eliminaci√≥n:', result.error);
                return { success: false, error: result.error };
            }
            
        } catch (error) {
            console.error('‚ùå Error probando eliminaci√≥n:', error);
            return { success: false, error: error.message };
        }
    }
}

// Funci√≥n global para ejecutar las pruebas
window.testImageFunctionality = async function() {
    const tester = new ImageFunctionalityTester();
    return await tester.initialize();
};

// Funci√≥n global para probar eliminaci√≥n espec√≠fica
window.testImageDeletion = async function(propertyId, imageId) {
    const tester = new ImageFunctionalityTester();
    await tester.initialize();
    return await tester.testImageDeletion(propertyId, imageId);
};

// Auto-ejecutar si estamos en el panel de administraci√≥n
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        if (window.location.pathname.includes('admin-properties.html')) {
            setTimeout(() => window.testImageFunctionality(), 3000);
        }
    });
} else {
    if (window.location.pathname.includes('admin-properties.html')) {
        setTimeout(() => window.testImageFunctionality(), 3000);
    }
}

console.log('‚úÖ Script de pruebas de funcionalidad de im√°genes cargado');