name: Deploy to Bluehost with DNS Configuration

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      dns_method:
        description: 'DNS Configuration Method'
        required: true
        default: 'bluehost-nameservers'
        type: choice
        options:
        - bluehost-nameservers
        - external-dns
        - custom-domain

jobs:
  deploy-with-dns:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate DNS configuration
      run: |
        echo "ğŸ” Validando configuraciÃ³n DNS..."
        echo "MÃ©todo seleccionado: ${{ github.event.inputs.dns_method || 'bluehost-nameservers' }}"
        
        # Verificar que el dominio estÃ© configurado
        if [ "${{ github.event.inputs.dns_method || 'bluehost-nameservers' }}" == "bluehost-nameservers" ]; then
          echo "âœ… Usando nameservers de Bluehost"
          echo "ğŸŒ Dominio: casanuvera.cl"
          echo "ğŸ“¡ Nameservers: ns1.bluehost.com, ns2.bluehost.com"
        elif [ "${{ github.event.inputs.dns_method }}" == "external-dns" ]; then
          echo "âœ… Usando DNS externo (dnsmisitio.net)"
          echo "ğŸŒ Dominio: casanuvera.cl"
          echo "ğŸ“¡ Nameservers: ns1.dnsmisitio.net, ns2.dnsmisitio.net"
        else
          echo "âœ… Usando configuraciÃ³n personalizada"
        fi
        
    - name: Prepare deployment files
      run: |
        echo "ğŸ“¦ Preparando archivos para deploy..."
        
        # Crear directorio de deploy
        mkdir -p dns-deploy
        
        # Copiar archivos principales
        cp *.html dns-deploy/ 2>/dev/null || true
        cp *.css dns-deploy/ 2>/dev/null || true
        cp *.js dns-deploy/ 2>/dev/null || true
        
        # Copiar carpetas
        if [ -d "css" ]; then cp -r css dns-deploy/; fi
        if [ -d "js" ]; then cp -r js dns-deploy/; fi
        
        # Limpiar archivos de desarrollo
        find dns-deploy -name "test-*" -delete
        find dns-deploy -name "debug-*" -delete
        find dns-deploy -name "diagnostico-*" -delete
        find dns-deploy -name "verificar-*" -delete
        find dns-deploy -name "fix-*" -delete
        find dns-deploy -name "improved-*" -delete
        find dns-deploy -name "lead-*" -delete
        find dns-deploy -name "database-*" -delete
        find dns-deploy -name "compras-loader-*" -delete
        find dns-deploy -name "form-scripts*" -delete
        find dns-deploy -name "google-maps-*" -delete
        find dns-deploy -name "property-detail-*" -delete
        find dns-deploy -name "property-loader*" -delete
        find dns-deploy -name "property-handler*" -delete
        find dns-deploy -name "whatsapp-widget-intelligent*" -delete
        
        echo "ğŸ“ Archivos listos para deploy:"
        find dns-deploy -type f | sort
        echo "ğŸ“Š Total archivos: $(find dns-deploy -type f | wc -l)"
        
    - name: Deploy to Bluehost
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.BLUEHOST_FTP_SERVER }}
        username: ${{ secrets.BLUEHOST_FTP_USERNAME }}
        password: ${{ secrets.BLUEHOST_FTP_PASSWORD }}
        local-dir: ./dns-deploy/
        server-dir: /public_html/
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.github/**
          **/*.md
          **/*.sql
          
    - name: Verify DNS configuration
      run: |
        echo "ğŸ” Verificando configuraciÃ³n DNS..."
        
        # Verificar nameservers actuales
        echo "ğŸ“¡ Nameservers actuales de casanuvera.cl:"
        dig NS casanuvera.cl +short || echo "No se pudo obtener nameservers"
        
        # Verificar IP del dominio
        echo "ğŸŒ IP actual de casanuvera.cl:"
        dig A casanuvera.cl +short || echo "No se pudo obtener IP"
        
        # Verificar www subdomain
        echo "ğŸŒ IP de www.casanuvera.cl:"
        dig A www.casanuvera.cl +short || echo "No se pudo obtener IP de www"
        
    - name: Post-deployment verification
      run: |
        echo "ğŸ‰ Deploy con DNS completado!"
        echo "ğŸŒ Sitio: https://casanuvera.cl"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ“… Timestamp: $(date)"
        echo "ğŸ”„ Commit: ${{ github.sha }}"
        echo "ğŸ“¡ MÃ©todo DNS: ${{ github.event.inputs.dns_method || 'bluehost-nameservers' }}"
        
        echo ""
        echo "ğŸ“‹ Verificaciones recomendadas:"
        echo "1. âœ… https://casanuvera.cl carga correctamente"
        echo "2. âœ… https://www.casanuvera.cl redirige correctamente"
        echo "3. âœ… Todas las pÃ¡ginas HTML funcionan"
        echo "4. âœ… JavaScript y CSS cargan correctamente"
        echo "5. âœ… IntegraciÃ³n con Supabase funciona"
        echo "6. âœ… Widget de WhatsApp funciona"
        echo "7. âœ… DiseÃ±o responsivo en mÃ³viles"
        
        echo ""
        echo "ğŸ” Herramientas de verificaciÃ³n DNS:"
        echo "- DNS Checker: https://dnschecker.org"
        echo "- What's My DNS: https://whatsmydns.net"
        echo "- Comando: dig casanuvera.cl"
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ Deploy exitoso a casanuvera.cl con configuraciÃ³n DNS"
        else
          echo "âŒ Deploy fallÃ³ - revisar configuraciÃ³n DNS y credenciales"
        fi